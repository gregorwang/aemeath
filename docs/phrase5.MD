# ğŸ“ Project Cyber-Companion å¼€å‘æ–‡æ¡£ (Phase 5)

## â€”â€” å·¥ç¨‹åŒ–å®æ–½ï¼šæ‰“åŒ…ã€ä¼˜åŒ–ä¸å‘å¸ƒ

---

## 5.0 é˜¶æ®µæ¦‚è¿° (Phase Overview)

è¿™æ˜¯æ„å»ºè½¯ä»¶äº§å“ä¸­**æå…¶é‡è¦ä½†ç»å¸¸è¢«å¿½è§†**çš„ä¸€ç¯ï¼šå¦‚ä½•è®©ä»£ç èµ°å‡º IDEï¼Œè¿è¡Œåœ¨åˆ«äººçš„ç”µè„‘ä¸Šã€‚

å¯¹äº Python GUI åº”ç”¨ï¼ˆå°¤å…¶æ¶‰åŠ AI åº“ï¼‰ï¼Œ**æ‰“åŒ…ä½“ç§¯å¤§ã€å¯åŠ¨æ…¢ã€ä¾èµ–å†²çª**æ˜¯ä¸‰å¤§æ¶æ¢¦ã€‚

### æœ¬é˜¶æ®µç›®æ ‡

| ç›®æ ‡ | æŒ‡æ ‡ | å®ç°æ–¹æ¡ˆ |
|------|------|---------|
| **ç‹¬ç«‹è¿è¡Œ** | åœ¨æ—  Python ç¯å¢ƒçš„ç”µè„‘ä¸Šè¿è¡Œ | PyInstaller æ‰“åŒ… |
| **ä½“ç§¯æ§åˆ¶** | æ ¸å¿ƒåŒ… < 200MB | ä¾èµ–ç²¾ç®€ + æ’é™¤ç­–ç•¥ |
| **å¿«é€Ÿå¯åŠ¨** | å†·å¯åŠ¨ < 5 ç§’ | æ‡’åŠ è½½ + å¯åŠ¨ç”»é¢ |
| **æŒç»­äº¤ä»˜** | ä¸€é”®å‘å¸ƒ | GitHub Actions CI/CD |
| **è‡ªåŠ¨æ›´æ–°** | ç”¨æˆ·æ— æ„Ÿæ›´æ–° | Launcher + OTA |

### å‰ç½®ä¾èµ–

- Phase 1-4 å…¨éƒ¨ä»£ç å¼€å‘å®Œæˆ
- æ‰€æœ‰æ¨¡å—é€šè¿‡å•å…ƒæµ‹è¯•
- GitHub ä»“åº“å·²åˆ›å»º

---

## 5.1 æ‰“åŒ…ç­–ç•¥ (Packaging Strategy)

### æ ¸å¿ƒå·¥å…·: PyInstaller

> âš ï¸ **ä¸è¦ç›´æ¥ç”¨å‘½ä»¤è¡Œ** `pyinstaller main.py`ï¼å¿…é¡»ç¼–å†™ `.spec` æ–‡ä»¶è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚

### 5.1.1 å®Œæ•´ `.spec` æ–‡ä»¶

```python
# build.spec
# PyInstaller æ‰“åŒ…é…ç½®æ–‡ä»¶
# ä½¿ç”¨æ–¹æ³•: pyinstaller build.spec

import sys
from pathlib import Path

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT = Path(SPECPATH)

a = Analysis(
    # â”€â”€ å…¥å£æ–‡ä»¶ â”€â”€
    [str(PROJECT_ROOT / 'src' / 'main.py')],
    
    # â”€â”€ æœç´¢è·¯å¾„ â”€â”€
    pathex=[str(PROJECT_ROOT / 'src')],
    
    # â”€â”€ äºŒè¿›åˆ¶æ–‡ä»¶ â”€â”€
    binaries=[],
    
    # â”€â”€ èµ„æºæ–‡ä»¶æ˜ å°„ â”€â”€
    # æ ¼å¼: (æºè·¯å¾„, ç›®æ ‡è·¯å¾„)
    # æ³¨æ„: ç›®æ ‡è·¯å¾„æ˜¯ç›¸å¯¹äºæ‰“åŒ…å _internal ç›®å½•çš„è·¯å¾„
    datas=[
        # è§’è‰²èµ„æºåŒ…
        (str(PROJECT_ROOT / 'characters'), 'characters'),
        # é™æ€èµ„æº
        (str(PROJECT_ROOT / 'assets'), 'assets'),
        # é…ç½®æ–‡ä»¶
        (str(PROJECT_ROOT / 'config.json'), '.'),
        (str(PROJECT_ROOT / 'version.json'), '.'),
    ],
    
    # â”€â”€ éšå¼å¯¼å…¥ â”€â”€
    # PyInstaller æ— æ³•é€šè¿‡é™æ€åˆ†æå‘ç°çš„åŠ¨æ€å¯¼å…¥
    hiddenimports=[
        # PySide6 å¤šåª’ä½“
        'PySide6.QtMultimedia',
        'PySide6.QtMultimediaWidgets',
        
        # edge-tts ä¾èµ–
        'edge_tts',
        'aiohttp',
        
        # MediaPipe (å¦‚æœæ‰“åŒ… Phase 4)
        # 'mediapipe',
        # 'mediapipe.python',
        # 'mediapipe.python.solutions',
        
        # OpenCV (å¦‚æœéœ€è¦)
        # 'cv2',
        
        # å…¶ä»–å¯èƒ½çš„åŠ¨æ€å¯¼å…¥
        'json',
        'yaml',
        'hashlib',
    ],
    
    # â”€â”€ æ’é™¤åˆ—è¡¨ â”€â”€
    # ä¸éœ€è¦çš„é‡å‹åº“ï¼ˆå¤§å¹…å‡å°ä½“ç§¯ï¼‰
    excludes=[
        # GUI ç›¸å…³ï¼ˆæˆ‘ä»¬ç”¨ PySide6ï¼Œä¸éœ€è¦ tkinterï¼‰
        'tkinter',
        '_tkinter',
        'tk',
        
        # æ•°æ®ç§‘å­¦ï¼ˆå¦‚æœ numpy æ‹‰å…¥äº†è¿™äº›ï¼‰
        'matplotlib',
        'scipy',
        'pandas',
        'sklearn',
        'scikit-learn',
        
        # Jupyter / IPython
        'IPython',
        'jupyter',
        'notebook',
        'ipykernel',
        'ipywidgets',
        
        # æµ‹è¯•æ¡†æ¶
        'pytest',
        'unittest',
        'doctest',
        
        # ä¸éœ€è¦çš„æ ‡å‡†åº“
        'lib2to3',
        'pydoc_data',
        'ensurepip',
        'venv',
    ],
    
    # â”€â”€ è¿è¡Œæ—¶é’©å­ â”€â”€
    runtime_hooks=[
        str(PROJECT_ROOT / 'tools' / 'runtime_hook.py'),
    ],
    
    hookspath=[],
    hooksconfig={},
    
    # â”€â”€ ç¼–ç  â”€â”€
    noarchive=False,
)

# â”€â”€ PYZ å‹ç¼© â”€â”€
pyz = PYZ(a.pure, a.zipped_data)

# â”€â”€ å¯æ‰§è¡Œæ–‡ä»¶é…ç½® â”€â”€
exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,    # True = ç”Ÿæˆç›®å½•æ¨¡å¼ï¼ˆæ¨èï¼‰
    name='CyberCompanion',    # å¯æ‰§è¡Œæ–‡ä»¶å
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,              # Windows ä¸Šä¸è¦ strip
    upx=True,                 # ä½¿ç”¨ UPX å‹ç¼© DLLï¼ˆéœ€å®‰è£… UPXï¼‰
    console=False,            # False = æ— æ§åˆ¶å°çª—å£ï¼ˆGUI æ¨¡å¼ï¼‰
    disable_windowed_traceback=False,
    argv_emulation=False,
    
    # â”€â”€ å›¾æ ‡ â”€â”€
    icon=str(PROJECT_ROOT / 'assets' / 'icon.ico'),
    
    # â”€â”€ Windows å…ƒæ•°æ® â”€â”€
    version='file_version_info.txt',  # å¯é€‰ï¼šWindows æ–‡ä»¶ç‰ˆæœ¬ä¿¡æ¯
)

# â”€â”€ ç›®å½•æ¨¡å¼æ”¶é›† â”€â”€
coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[
        # è¿™äº› DLL ä¸èƒ½è¢« UPX å‹ç¼©ï¼ˆä¼šå¯¼è‡´å´©æºƒï¼‰
        'vcruntime140.dll',
        'python3*.dll',
        'Qt6*.dll',           # Qt DLL å‹ç¼©åå¯èƒ½ä¸ç¨³å®š
    ],
    name='CyberCompanion',    # è¾“å‡ºç›®å½•å
)
```

### 5.1.2 è¿è¡Œæ—¶é’©å­

```python
# tools/runtime_hook.py
# åœ¨ç¨‹åºå¯åŠ¨çš„æœ€æ—©æœŸæ‰§è¡Œï¼Œæ—©äºä»»ä½•ä¸šåŠ¡ä»£ç 

import os
import sys


def _setup_environment():
    """
    è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒ
    
    è§£å†³çš„é—®é¢˜:
    1. æ‰“åŒ…åèµ„æºæ–‡ä»¶è·¯å¾„å˜åŒ–
    2. DLL æœç´¢è·¯å¾„
    3. ç¼–ç é—®é¢˜
    """
    # åˆ¤æ–­æ˜¯å¦æ˜¯æ‰“åŒ…åçš„ç¯å¢ƒ
    if getattr(sys, 'frozen', False):
        # æ‰“åŒ…åçš„æ ¹ç›®å½•
        base_dir = sys._MEIPASS
    else:
        # å¼€å‘ç¯å¢ƒ
        base_dir = os.path.dirname(os.path.abspath(__file__))
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    os.environ['APP_BASE_DIR'] = base_dir
    
    # ç¡®ä¿ UTF-8 ç¼–ç 
    os.environ['PYTHONIOENCODING'] = 'utf-8'


_setup_environment()
```

### 5.1.3 èµ„æºè·¯å¾„å·¥å…·

```python
# src/core/paths.py

import os
import sys
from pathlib import Path


def get_base_dir() -> Path:
    """
    è·å–åº”ç”¨ç¨‹åºæ ¹ç›®å½•
    
    å¼€å‘ç¯å¢ƒ: é¡¹ç›®æ ¹ç›®å½•
    æ‰“åŒ…ç¯å¢ƒ: PyInstaller çš„ _MEIPASS ä¸´æ—¶ç›®å½•
    
    ä½¿ç”¨:
        base = get_base_dir()
        config_path = base / "config.json"
        sprites_dir = base / "characters" / "rem_maid" / "assets" / "sprites"
    """
    if getattr(sys, 'frozen', False):
        return Path(sys._MEIPASS)
    else:
        return Path(__file__).parent.parent.parent  # src/core/paths.py â†’ é¡¹ç›®æ ¹ç›®å½•


def get_user_data_dir() -> Path:
    """
    è·å–ç”¨æˆ·æ•°æ®ç›®å½• (å¯å†™å…¥)
    
    æ‰“åŒ…åçš„ _MEIPASS æ˜¯åªè¯»çš„ï¼
    ç”¨æˆ·æ•°æ®ï¼ˆç¼“å­˜ã€è®¾ç½®ã€æ—¥å¿—ï¼‰å¿…é¡»å†™åˆ°ç”¨æˆ·ç›®å½•
    
    è·¯å¾„: C:/Users/<username>/AppData/Local/CyberCompanion/
    """
    if sys.platform == 'win32':
        base = Path(os.environ.get('LOCALAPPDATA', Path.home() / 'AppData' / 'Local'))
    else:
        base = Path.home() / '.local' / 'share'
    
    user_dir = base / 'CyberCompanion'
    user_dir.mkdir(parents=True, exist_ok=True)
    return user_dir


def get_cache_dir() -> Path:
    """éŸ³é¢‘ç¼“å­˜ç›®å½•"""
    cache_dir = get_user_data_dir() / 'cache' / 'audio'
    cache_dir.mkdir(parents=True, exist_ok=True)
    return cache_dir


def get_log_dir() -> Path:
    """æ—¥å¿—ç›®å½•"""
    log_dir = get_user_data_dir() / 'logs'
    log_dir.mkdir(parents=True, exist_ok=True)
    return log_dir
```

### 5.1.4 ä¾èµ–ç²¾ç®€ç­–ç•¥ (Dependency Pruning)

> âš ï¸ **æ ¸å¿ƒåŸåˆ™**: ä½¿ç”¨å¹²å‡€çš„è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…ï¼Œç»ä¸ä½¿ç”¨å…¨å±€ Python ç¯å¢ƒï¼

#### æ‰“åŒ…ç¯å¢ƒæ­å»º

```powershell
# 1. åˆ›å»ºå¹²å‡€çš„æ‰“åŒ…è™šæ‹Ÿç¯å¢ƒï¼ˆä¸å¼€å‘ç¯å¢ƒåˆ†å¼€ï¼‰
python -m venv build_env

# 2. æ¿€æ´»
.\build_env\Scripts\Activate.ps1

# 3. åªå®‰è£…æœ€å°å¿…éœ€ä¾èµ–
pip install -r requirements-build.txt

# 4. å®‰è£… PyInstaller
pip install pyinstaller>=6.0.0

# 5. æ‰“åŒ…
pyinstaller build.spec

# 6. è¾“å‡ºåœ¨ dist/CyberCompanion/ ç›®å½•
```

#### `requirements-build.txt` â€” æ‰“åŒ…ä¸“ç”¨ä¾èµ–æ¸…å•

```txt
# Phase 1-3 æ ¸å¿ƒä¾èµ–
PySide6==6.6.1                # é”å®šç²¾ç¡®ç‰ˆæœ¬
Pillow==10.2.0
numpy==1.26.4
edge-tts==6.1.12
pywin32==306

# Phase 4 å¯é€‰ä¾èµ–ï¼ˆæ ¹æ®éœ€è¦å–æ¶ˆæ³¨é‡Šï¼‰
# mediapipe==0.10.9
# opencv-python-headless==4.9.0.80    # headless ç‰ˆæœ¬ï¼æ¯”å®Œæ•´ç‰ˆå° 100MB+
# mss==9.0.1
# paddleocr==2.7.3
# httpx==0.27.0
# openai==1.12.0

# âš ï¸ æ³¨æ„:
# - ä½¿ç”¨ opencv-python-headless è€Œä¸æ˜¯ opencv-python
#   headless ç‰ˆæœ¬ä¸åŒ…å« GUI åŠŸèƒ½ï¼ˆæˆ‘ä»¬ç”¨ PySide6ï¼Œä¸éœ€è¦ cv2 GUIï¼‰
#   ä½“ç§¯: headless ~30MB vs å®Œæ•´ç‰ˆ ~130MB
# - PaddleOCR ä½“ç§¯å¤§ï¼ˆ~500MBï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨ Windows åŸç”Ÿ OCR æ›¿ä»£
```

### 5.1.5 ä½“ç§¯å¯¹ç…§è¡¨

| ç»„ä»¶ | å®Œæ•´åŒ… | ç²¾ç®€å | èŠ‚çœ |
|------|--------|--------|------|
| PySide6 | ~150MB | ~80MB (æ’é™¤ Designer/QML) | 70MB |
| NumPy | ~30MB | ~30MB | - |
| Pillow | ~10MB | ~10MB | - |
| OpenCV (å®Œæ•´) | ~130MB | - | 130MB |
| OpenCV (headless) | - | ~30MB | 100MB |
| MediaPipe | ~30MB | ~30MB | - |
| PaddleOCR | ~500MB | ~0 (ç”¨åŸç”Ÿæ›¿ä»£) | 500MB |
| tkinter | ~20MB | ~0 (æ’é™¤) | 20MB |
| **æ€»è®¡** | ~870MB | ~180MB | **690MB** |

---

## 5.2 æ€§èƒ½ä¼˜åŒ– (Performance Optimization)

### 5.2.1 å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼šæ‡’åŠ è½½ (Lazy Loading)

Python è§£é‡Šå™¨å¯åŠ¨å¾ˆå¿«ï¼ˆ~50msï¼‰ï¼Œä½† `import` å·¨é‡çš„åº“éå¸¸æ…¢ã€‚

**é—®é¢˜**: å¦‚æœä»£ç é¡¶éƒ¨å†™äº† `import torch` æˆ– `import cv2`ï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šå¡ 3-5 ç§’åŠ è½½ DLLã€‚

#### è®¾è®¡æ¨¡å¼ï¼šä»£ç†å¯¼å…¥ (Proxy Import)

```python
# âŒ Bad Practice â€” ç¨‹åºä¸€å¯åŠ¨å°±å¡ä½åŠ è½½æ‰€æœ‰ AI åº“

import cv2                    # åŠ è½½æ—¶é—´: ~800ms
import mediapipe as mp        # åŠ è½½æ—¶é—´: ~1200ms  
import edge_tts               # åŠ è½½æ—¶é—´: ~200ms
from paddleocr import PaddleOCR  # åŠ è½½æ—¶é—´: ~3000ms

class GazeTracker:
    def detect_face(self, frame):
        ...
```

```python
# âœ… Good Practice â€” åªåœ¨åŠŸèƒ½é¦–æ¬¡ä½¿ç”¨æ—¶æ‰åŠ è½½å¯¹åº”åº“

class GazeTracker:
    """
    æ‡’åŠ è½½ç¤ºä¾‹:
    - cv2 å’Œ mediapipe åªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ detect_face() æ—¶åŠ è½½
    - ç”¨æˆ·å¦‚æœä»æœªä½¿ç”¨è§†è§‰åŠŸèƒ½ï¼Œè¿™äº›åº“æ°¸è¿œä¸ä¼šè¢«åŠ è½½
    - é¦–æ¬¡è°ƒç”¨ä¼šæœ‰ 1-2 ç§’å»¶è¿Ÿï¼Œåç»­è°ƒç”¨æ— å»¶è¿Ÿ
    """
    
    _cv2 = None          # ç±»çº§åˆ«ç¼“å­˜
    _mediapipe = None
    
    @classmethod
    def _ensure_cv2(cls):
        """å»¶è¿ŸåŠ è½½ OpenCV"""
        if cls._cv2 is None:
            import cv2
            cls._cv2 = cv2
        return cls._cv2
    
    @classmethod
    def _ensure_mediapipe(cls):
        """å»¶è¿ŸåŠ è½½ MediaPipe"""
        if cls._mediapipe is None:
            import mediapipe
            cls._mediapipe = mediapipe
        return cls._mediapipe
    
    def detect_face(self, frame):
        cv2 = self._ensure_cv2()         # é¦–æ¬¡è°ƒç”¨: ~800ms, åç»­: ~0ms
        mp = self._ensure_mediapipe()     # é¦–æ¬¡è°ƒç”¨: ~1200ms, åç»­: ~0ms
        # ... ä½¿ç”¨ cv2 å’Œ mp ...
```

#### å¯åŠ¨æµç¨‹ä¼˜åŒ–

```python
# src/main.py â€” ä¼˜åŒ–åçš„å¯åŠ¨æµç¨‹

import os
import sys

# â”€â”€ Step 1: ç¯å¢ƒè®¾ç½® (< 1ms) â”€â”€
os.environ["QT_ENABLE_HIGHDPI_SCALING"] = "1"

# â”€â”€ Step 2: æœ€å° GUI å¯¼å…¥ (< 200ms) â”€â”€
from PySide6.QtWidgets import QApplication

# â”€â”€ Step 3: å¯åŠ¨ç”»é¢ (< 50ms) â”€â”€
app = QApplication(sys.argv)

# å¦‚æœä½¿ç”¨ PyInstaller çš„å†…ç½® splash
try:
    import pyi_splash
    pyi_splash.update_text("æ­£åœ¨å”¤é†’èµ›åšä¼´ä¾£...")
except ImportError:
    pass  # éæ‰“åŒ…ç¯å¢ƒ

# â”€â”€ Step 4: åŠ è½½æ ¸å¿ƒæ¨¡å— (< 100ms) â”€â”€
# åªåŠ è½½ GUI å’Œç›‘æ§ â€” è¿™äº›éƒ½å¾ˆè½»é‡
from core.idle_monitor import IdleMonitor
from core.director import Director
from ui.entity_window import EntityWindow

# â”€â”€ Step 5: åˆå§‹åŒ– (< 50ms) â”€â”€
window = EntityWindow()
monitor = IdleMonitor()
director = Director(window, ...)

# â”€â”€ Step 6: å…³é—­å¯åŠ¨ç”»é¢ â”€â”€
try:
    pyi_splash.close()
except NameError:
    pass

# â”€â”€ Step 7: å¯åŠ¨äº‹ä»¶å¾ªç¯ â”€â”€
monitor.start()
sys.exit(app.exec())

# â± æ€»å¯åŠ¨æ—¶é—´: < 500ms (ä¸å« AI æ¨¡å—)
# AI æ¨¡å— (cv2, mediapipe, llm) åœ¨ç”¨æˆ·é¦–æ¬¡è§¦å‘åŠŸèƒ½æ—¶æ‰åŠ è½½
```

#### å¯åŠ¨ç”»é¢ (Splash Screen)

```python
# PyInstaller æ‰“åŒ…æ—¶æ·»åŠ å¯åŠ¨ç”»é¢:
# åœ¨ build.spec çš„ EXE å—ä¸­æ·»åŠ :

exe = EXE(
    ...
    splash='assets/splash.png',          # å¯åŠ¨ç”»é¢å›¾ç‰‡
    splash_timeout=0,                     # 0 = æ‰‹åŠ¨å…³é—­
)
```

### 5.2.2 å†…å­˜å ç”¨ä¼˜åŒ–

```python
class MemoryManager:
    """
    å†…å­˜ç®¡ç†å™¨
    
    èŒè´£:
    - ç›‘æ§å„å­è¿›ç¨‹/çº¿ç¨‹çš„å†…å­˜ä½¿ç”¨
    - åœ¨ç©ºé—²æ—¶ä¸»åŠ¨é‡Šæ”¾èµ„æº
    - å®ç°"æŒ‰éœ€å¯åŠ¨ï¼Œç”¨å®Œå³ç„š"çš„ AI å­è¿›ç¨‹ç­–ç•¥
    
    ç­–ç•¥:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç»„ä»¶          â”‚ å†…å­˜å ç”¨  â”‚ ç”Ÿå‘½å‘¨æœŸ        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ GUI ä¸»è¿›ç¨‹    â”‚ ~30MB    â”‚ æ°¸ä¹…è¿è¡Œ        â”‚
    â”‚ IdleMonitor   â”‚ ~2MB     â”‚ æ°¸ä¹…è¿è¡Œ        â”‚
    â”‚ AudioManager  â”‚ ~10MB    â”‚ æ°¸ä¹…è¿è¡Œ        â”‚
    â”‚ GazeTracker   â”‚ ~200MB   â”‚ è§’è‰²å¯è§æ—¶å¯åŠ¨  â”‚
    â”‚ LLM è¿›ç¨‹      â”‚ ~4-8GB   â”‚ å¯¹è¯æ—¶å¯åŠ¨      â”‚
    â”‚ OCR å¼•æ“      â”‚ ~300MB   â”‚ æˆªå±åˆ†ææ—¶å¯åŠ¨  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    é‡Šæ”¾ç­–ç•¥:
    - GazeTracker: è§’è‰²éšè—åç«‹å³é‡Šæ”¾æ‘„åƒå¤´å’Œæ¨¡å‹
    - LLM: å¯¹è¯ç»“æŸ 5 åˆ†é’Ÿå terminate() è¿›ç¨‹
    - OCR: ä¸€æ¬¡æ€§ä½¿ç”¨åé‡Šæ”¾
    """
    
    LLM_IDLE_TIMEOUT_SECONDS = 300  # 5 åˆ†é’Ÿ
    
    def release_idle_resources(self):
        """
        é‡Šæ”¾ç©ºé—²èµ„æº
        
        è°ƒç”¨æ—¶æœº: æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
        """
        # æ£€æŸ¥ LLM è¿›ç¨‹æ˜¯å¦ç©ºé—²è¶…è¿‡ 5 åˆ†é’Ÿ
        if self._llm_process and self._llm_idle_seconds > self.LLM_IDLE_TIMEOUT_SECONDS:
            self._llm_process.terminate()
            self._llm_process = None
            # é‡Šæ”¾ 4-8GB å†…å­˜
            
        # æ£€æŸ¥ GazeTracker æ˜¯å¦éœ€è¦é‡Šæ”¾
        if self._gaze_tracker and self._entity_state == EntityState.HIDDEN:
            self._gaze_tracker.stop()
            self._gaze_tracker = None
            # é‡Šæ”¾ ~200MB å†…å­˜
```

---

## 5.3 è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ (Update System)

### æ¶æ„: å¼•å¯¼å™¨ + æ ¸å¿ƒåŒ… (Launcher + Core)

```
ç”¨æˆ·æ¡Œé¢
â”œâ”€â”€ CyberCompanion.exe         â† Launcher (å…¥å£, ~2MB, å¾ˆå°‘æ›´æ–°)
â”‚
â””â”€â”€ /Core                      â† ä¸šåŠ¡åŒ… (æ‰€æœ‰ Python é€»è¾‘, ~180MB)
    â”œâ”€â”€ CyberCompanion-core.exe
    â”œâ”€â”€ _internal/
    â”‚   â”œâ”€â”€ PySide6/
    â”‚   â”œâ”€â”€ characters/
    â”‚   â””â”€â”€ ...
    â””â”€â”€ version.json

è¿œç¨‹æœåŠ¡å™¨ (GitHub Releases / S3)
â”œâ”€â”€ latest_version.json        â† å½“å‰æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
â””â”€â”€ CyberCompanion_v1.2.0.zip  â† ä¸‹è½½åŒ…
```

### 5.3.1 Launcher é€»è¾‘

```python
# tools/launcher.py
# ç¼–è¯‘ä¸ºç‹¬ç«‹çš„ Launcher.exeï¼ˆä½¿ç”¨ PyInstaller å•æ–‡ä»¶æ¨¡å¼æ‰“åŒ…ï¼‰

import json
import os
import sys
import urllib.request
import zipfile
import shutil
from pathlib import Path


# â”€â”€ é…ç½® â”€â”€
UPDATE_URL = "https://api.github.com/repos/YOUR_USERNAME/CyberCompanion/releases/latest"
CORE_DIR = Path(os.path.dirname(sys.executable)) / "Core"
TEMP_DIR = Path(os.environ.get('TEMP', '/tmp')) / "CyberCompanion_update"


def get_current_version() -> str:
    """è¯»å–æœ¬åœ°ç‰ˆæœ¬å·"""
    version_file = CORE_DIR / "version.json"
    if version_file.exists():
        with open(version_file, "r") as f:
            return json.load(f).get("version", "0.0.0")
    return "0.0.0"


def check_for_update() -> dict | None:
    """
    æ£€æŸ¥è¿œç¨‹æœ€æ–°ç‰ˆæœ¬
    
    è¿”å›:
        æ›´æ–°ä¿¡æ¯ dict æˆ– Noneï¼ˆæ— æ›´æ–°ï¼‰
    
    GitHub Release API è¿”å›æ ¼å¼:
    {
        "tag_name": "v1.2.0",
        "assets": [
            {
                "name": "CyberCompanion_v1.2.0.zip",
                "browser_download_url": "https://..."
            }
        ]
    }
    """
    try:
        req = urllib.request.Request(UPDATE_URL)
        req.add_header("Accept", "application/vnd.github.v3+json")
        req.add_header("User-Agent", "CyberCompanion-Launcher")
        
        with urllib.request.urlopen(req, timeout=10) as response:
            release = json.loads(response.read())
        
        remote_version = release["tag_name"].lstrip("v")
        local_version = get_current_version()
        
        if remote_version > local_version:
            # å¯»æ‰¾ zip æ–‡ä»¶èµ„äº§
            for asset in release.get("assets", []):
                if asset["name"].endswith(".zip"):
                    return {
                        "version": remote_version,
                        "download_url": asset["browser_download_url"],
                        "size": asset.get("size", 0),
                    }
    except Exception as e:
        print(f"[Launcher] æ›´æ–°æ£€æŸ¥å¤±è´¥: {e}")
    
    return None


def download_and_apply_update(update_info: dict) -> bool:
    """
    ä¸‹è½½å¹¶åº”ç”¨æ›´æ–°
    
    æ­¥éª¤:
    1. ä¸‹è½½ zip åˆ°ä¸´æ—¶ç›®å½•
    2. éªŒè¯å®Œæ•´æ€§ (æ–‡ä»¶å¤§å°)
    3. å¤‡ä»½å½“å‰ Core ç›®å½•
    4. è§£å‹è¦†ç›– Core ç›®å½•
    5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ—§å¤‡ä»½
    
    è¿”å›:
        True: æ›´æ–°æˆåŠŸ
        False: æ›´æ–°å¤±è´¥ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ï¼‰
    """
    try:
        # Step 1: ä¸‹è½½
        TEMP_DIR.mkdir(parents=True, exist_ok=True)
        zip_path = TEMP_DIR / "update.zip"
        
        print(f"[Launcher] ä¸‹è½½æ›´æ–° v{update_info['version']}...")
        urllib.request.urlretrieve(update_info["download_url"], str(zip_path))
        
        # Step 2: éªŒè¯
        if update_info["size"] > 0:
            actual_size = zip_path.stat().st_size
            if actual_size != update_info["size"]:
                print(f"[Launcher] æ–‡ä»¶å¤§å°ä¸åŒ¹é…: æœŸæœ› {update_info['size']}, å®é™… {actual_size}")
                return False
        
        # Step 3: å¤‡ä»½
        backup_dir = CORE_DIR.parent / "Core_backup"
        if backup_dir.exists():
            shutil.rmtree(backup_dir)
        if CORE_DIR.exists():
            shutil.copytree(CORE_DIR, backup_dir)
        
        # Step 4: è§£å‹è¦†ç›–
        with zipfile.ZipFile(zip_path, 'r') as z:
            z.extractall(CORE_DIR)
        
        # Step 5: æ¸…ç†
        shutil.rmtree(TEMP_DIR, ignore_errors=True)
        shutil.rmtree(backup_dir, ignore_errors=True)
        
        print(f"[Launcher] æ›´æ–°æˆåŠŸ: v{update_info['version']}")
        return True
    
    except Exception as e:
        print(f"[Launcher] æ›´æ–°å¤±è´¥: {e}")
        # å›æ»š
        if backup_dir.exists() and not CORE_DIR.exists():
            shutil.copytree(backup_dir, CORE_DIR)
        return False


def launch_core():
    """å¯åŠ¨æ ¸å¿ƒç¨‹åº"""
    core_exe = CORE_DIR / "CyberCompanion-core.exe"
    if core_exe.exists():
        os.execv(str(core_exe), [str(core_exe)])
    else:
        print("[Launcher] é”™è¯¯: æ ¸å¿ƒç¨‹åºä¸å­˜åœ¨")
        sys.exit(1)


def main():
    """
    Launcher ä¸»æµç¨‹:
    1. æ£€æŸ¥æ›´æ–° (è¶…æ—¶ 10 ç§’)
    2. å¦‚æœæœ‰æ›´æ–° â†’ ä¸‹è½½å¹¶åº”ç”¨
    3. å¯åŠ¨æ ¸å¿ƒç¨‹åº
    
    è®¾è®¡è¦ç‚¹:
    - æ›´æ–°æ£€æŸ¥å¤±è´¥ä¸å½±å“å¯åŠ¨ï¼ˆé™é»˜è·³è¿‡ï¼‰
    - æ›´æ–°ä¸‹è½½å¤±è´¥ä¸å½±å“å¯åŠ¨ï¼ˆä½¿ç”¨æ—§ç‰ˆæœ¬ï¼‰
    - ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆåå°å®Œæˆæ‰€æœ‰æ“ä½œï¼‰
    """
    # æ£€æŸ¥æ›´æ–°
    update = check_for_update()
    if update:
        download_and_apply_update(update)
    
    # å¯åŠ¨æ ¸å¿ƒ
    launch_core()


if __name__ == "__main__":
    main()
```

### 5.3.2 å¢é‡æ›´æ–° (Delta Update) â€” è¿›é˜¶

å¯¹äº 200MB+ çš„åŒ…ï¼Œæ¯æ¬¡å…¨é‡ä¸‹è½½å¤ªæ…¢ã€‚

```python
class DeltaUpdater:
    """
    å¢é‡æ›´æ–°å™¨ (è¿›é˜¶åŠŸèƒ½)
    
    åŸç†:
    - ä½¿ç”¨ bsdiff/bspatch è¿›è¡ŒäºŒè¿›åˆ¶å·®åˆ†
    - åªä¸‹è½½å˜æ›´çš„æ–‡ä»¶ï¼ˆé€šå¸¸åªæœ‰å‡ ç™¾ KB çš„ .pyc å˜åŒ–ï¼‰
    
    è¿œç¨‹å­˜å‚¨ç»“æ„:
    /releases
      /v1.0.0
        full.zip              â† å®Œæ•´åŒ…
      /v1.1.0  
        full.zip              â† å®Œæ•´åŒ…
        patch_from_v1.0.0.bsp â† å·®åˆ†è¡¥ä¸ (é€šå¸¸ < 5MB)
    
    æ›´æ–°é€»è¾‘:
    1. æ£€æŸ¥æ˜¯å¦æœ‰ä»å½“å‰ç‰ˆæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬çš„å·®åˆ†è¡¥ä¸
    2. æœ‰ â†’ ä¸‹è½½å·®åˆ†è¡¥ä¸å¹¶åº”ç”¨
    3. æ²¡æœ‰ â†’ ä¸‹è½½å®Œæ•´åŒ…ï¼ˆé™çº§åˆ°å…¨é‡æ›´æ–°ï¼‰
    
    ä¾èµ–: bsdiff4 (pip install bsdiff4)
    """
    pass
```

---

## 5.4 è‡ªåŠ¨åŒ–æ„å»ºæµæ°´çº¿ (CI/CD Pipeline)

### GitHub Actions Workflow

```yaml
# .github/workflows/build.yml

name: Build & Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ tag (å¦‚ v1.0.0) æ—¶è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      # â”€â”€ Step 1: æ£€å‡ºä»£ç  â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
      
      # â”€â”€ Step 2: è®¾ç½® Python â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # â”€â”€ Step 3: åˆ›å»ºå¹²å‡€çš„è™šæ‹Ÿç¯å¢ƒ â”€â”€
      - name: Create Virtual Environment
        run: |
          python -m venv build_env
          .\build_env\Scripts\Activate.ps1
          pip install --upgrade pip
      
      # â”€â”€ Step 4: å®‰è£…ä¾èµ– â”€â”€
      - name: Install Dependencies
        run: |
          .\build_env\Scripts\Activate.ps1
          pip install -r requirements-build.txt
          pip install pyinstaller>=6.0.0
      
      # â”€â”€ Step 5: è¿è¡Œæµ‹è¯• â”€â”€
      - name: Run Tests
        run: |
          .\build_env\Scripts\Activate.ps1
          pip install pytest
          pytest tests/ -v --tb=short
      
      # â”€â”€ Step 6: æ‰“åŒ… â”€â”€
      - name: Build with PyInstaller
        run: |
          .\build_env\Scripts\Activate.ps1
          pyinstaller build.spec
      
      # â”€â”€ Step 7: å‹ç¼© â”€â”€
      - name: Create Archive
        run: |
          $version = "${{ github.ref_name }}"
          Compress-Archive -Path "dist\CyberCompanion\*" -DestinationPath "CyberCompanion_${version}.zip"
      
      # â”€â”€ Step 8: åˆ›å»º Release â”€â”€
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: CyberCompanion_*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### å‘å¸ƒæµç¨‹

```powershell
# å¼€å‘è€…æ‰§è¡Œï¼š
git tag v1.0.0
git push origin v1.0.0
# â†’ GitHub Actions è‡ªåŠ¨è§¦å‘ â†’ æ‰“åŒ… â†’ å‘å¸ƒ â†’ ç”¨æˆ·è‡ªåŠ¨æ›´æ–°
```

---

## 5.5 ç³»ç»Ÿæ‰˜ç›˜é›†æˆ (System Tray)

```python
# src/ui/tray_icon.py

from PySide6.QtWidgets import QSystemTrayIcon, QMenu
from PySide6.QtGui import QIcon, QAction
from PySide6.QtCore import Signal


class SystemTrayManager:
    """
    ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡ç®¡ç†å™¨
    
    åŠŸèƒ½:
    - åœ¨ Windows ç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤ºå›¾æ ‡
    - å³é”®èœå•: è®¾ç½® / åˆ‡æ¢è§’è‰² / å¬å”¤ / é€€å‡º
    - åŒå‡»: å¬å”¤/éšè—è§’è‰²
    - æ°”æ³¡é€šçŸ¥
    """
    
    def __init__(self, app, icon_path: str):
        self._tray = QSystemTrayIcon(QIcon(icon_path), app)
        self._setup_menu()
        self._tray.show()
    
    def _setup_menu(self):
        """
        æ„å»ºå³é”®èœå•:
        
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ­ åˆ‡æ¢è§’è‰²  â–º â”‚ â†’ å­èœå•: è§’è‰²åˆ—è¡¨
        â”‚ âš¡ ç«‹å³å¬å”¤     â”‚ â†’ æ— è§†ç©ºé—²æ—¶é—´ï¼Œç«‹å³å‡ºåœº
        â”‚ âš™ï¸ è®¾ç½®         â”‚ â†’ æ‰“å¼€è®¾ç½®çª—å£
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚ ğŸ“Š çŠ¶æ€         â”‚ â†’ æ˜¾ç¤ºå½“å‰çŠ¶æ€ä¿¡æ¯
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚ âŒ é€€å‡º         â”‚ â†’ å®Œå…¨é€€å‡ºç¨‹åº
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """
        menu = QMenu()
        
        # åˆ‡æ¢è§’è‰²
        char_menu = menu.addMenu("ğŸ­ åˆ‡æ¢è§’è‰²")
        # åŠ¨æ€å¡«å……è§’è‰²åˆ—è¡¨...
        
        # ç«‹å³å¬å”¤
        summon_action = menu.addAction("âš¡ ç«‹å³å¬å”¤")
        
        # è®¾ç½®
        settings_action = menu.addAction("âš™ï¸ è®¾ç½®")
        
        menu.addSeparator()
        
        # çŠ¶æ€
        status_action = menu.addAction("ğŸ“Š çŠ¶æ€")
        
        menu.addSeparator()
        
        # é€€å‡º
        quit_action = menu.addAction("âŒ é€€å‡º")
        quit_action.triggered.connect(QApplication.quit)
        
        self._tray.setContextMenu(menu)
```

---

## 5.6 æ—¥å¿—ç³»ç»Ÿ (Logging)

```python
# src/core/logger.py

import logging
from pathlib import Path
from logging.handlers import RotatingFileHandler


def setup_logger(log_dir: Path, debug: bool = False) -> logging.Logger:
    """
    é…ç½®æ—¥å¿—ç³»ç»Ÿ
    
    ç‰¹æ€§:
    - æ—¥å¿—æ–‡ä»¶è½®è½¬: æ¯ä¸ªæ–‡ä»¶æœ€å¤§ 5MB, ä¿ç•™æœ€è¿‘ 3 ä¸ªæ–‡ä»¶
    - æ—¥å¿—è·¯å¾„: AppData/Local/CyberCompanion/logs/
    - Debug æ¨¡å¼: åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
    
    æ—¥å¿—æ ¼å¼:
    [2026-01-15 14:30:22] [INFO] [idle_monitor] ç”¨æˆ·ç©ºé—²è§¦å‘: 185.3s
    [2026-01-15 14:30:22] [DEBUG] [director] é€‰æ‹©å°è¯: late_night_01
    """
    logger = logging.getLogger("CyberCompanion")
    logger.setLevel(logging.DEBUG if debug else logging.INFO)
    
    # æ–‡ä»¶å¤„ç†å™¨
    log_file = log_dir / "app.log"
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=5 * 1024 * 1024,  # 5MB
        backupCount=3,
        encoding="utf-8"
    )
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(logging.Formatter(
        "[%(asctime)s] [%(levelname)s] [%(name)s] %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S"
    ))
    logger.addHandler(file_handler)
    
    # æ§åˆ¶å°å¤„ç†å™¨ (ä»… debug æ¨¡å¼)
    if debug:
        console_handler = logging.StreamHandler()
        console_handler.setLevel(logging.DEBUG)
        console_handler.setFormatter(logging.Formatter(
            "[%(levelname)s] %(message)s"
        ))
        logger.addHandler(console_handler)
    
    return logger
```

---

## 5.7 æœ€ç»ˆé¡¹ç›®ç»“æ„ (Final Project Structure)

```
/CyberCompanion-Project
â”‚
â”œâ”€â”€ /src                        # æºä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # å…¥å£æ–‡ä»¶ (é«˜ DPI è®¾ç½® + å¯åŠ¨æµç¨‹)
â”‚   â”‚
â”‚   â”œâ”€â”€ /core                   # æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ idle_monitor.py     # Phase 1: Windows API ç©ºé—²æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ director.py         # Phase 1: å¯¼æ¼”æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ asset_manager.py    # Phase 1: èµ„æºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ audio_manager.py    # Phase 3: TTS è¯­éŸ³åˆæˆ + æ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ state_machine.py    # Phase 3: æœ‰é™çŠ¶æ€æœº
â”‚   â”‚   â”œâ”€â”€ script_engine.py    # Phase 3: å°è¯é€‰æ‹©å¼•æ“
â”‚   â”‚   â”œâ”€â”€ mood_system.py      # Phase 4: å¿ƒæƒ…ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ character_loader.py # Phase 3: è§’è‰²åŒ…åŠ è½½
â”‚   â”‚   â”œâ”€â”€ paths.py            # Phase 5: è·¯å¾„å·¥å…·
â”‚   â”‚   â””â”€â”€ logger.py           # Phase 5: æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚
â”‚   â”œâ”€â”€ /ui                     # ç•Œé¢å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ entity_window.py    # Phase 1: é€æ˜æ— è¾¹æ¡†çª—å£
â”‚   â”‚   â”œâ”€â”€ ascii_renderer.py   # Phase 2: ASCII å­—ç¬¦ç”»æ¸²æŸ“å¼•æ“
â”‚   â”‚   â””â”€â”€ tray_icon.py        # Phase 5: ç³»ç»Ÿæ‰˜ç›˜
â”‚   â”‚
â”‚   â””â”€â”€ /ai                     # æ™ºèƒ½å±‚
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ gaze_tracker.py     # Phase 4: MediaPipe è§†çº¿è¿½è¸ª
â”‚       â”œâ”€â”€ presence_detector.py # Phase 4: å­˜åœ¨æ£€æµ‹
â”‚       â”œâ”€â”€ llm_provider.py     # Phase 4: LLM æŠ½è±¡æ¥å£
â”‚       â””â”€â”€ screen_commentator.py # Phase 4: å±å¹•å†…å®¹åæ§½
â”‚
â”œâ”€â”€ /characters                 # è§’è‰²èµ„æºåŒ…
â”‚   â””â”€â”€ /rem_maid               # é»˜è®¤è§’è‰²
â”‚       â”œâ”€â”€ manifest.json
â”‚       â”œâ”€â”€ config.json
â”‚       â”œâ”€â”€ /assets
â”‚       â”‚   â”œâ”€â”€ /sprites        # idle.gif, peek.png, panic.gif, sleep.gif
â”‚       â”‚   â””â”€â”€ /sounds         # éŸ³æ•ˆæ–‡ä»¶
â”‚       â”œâ”€â”€ /scripts
â”‚       â”‚   â””â”€â”€ dialogue.yaml   # å°è¯åº“
â”‚       â””â”€â”€ /voice_cache        # TTS é¢„ç¼“å­˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚
â”œâ”€â”€ /assets                     # å…¨å±€é™æ€èµ„æº
â”‚   â”œâ”€â”€ icon.ico                # åº”ç”¨å›¾æ ‡
â”‚   â”œâ”€â”€ splash.png              # å¯åŠ¨ç”»é¢
â”‚   â””â”€â”€ /models                 # AI æ¨¡å‹æ–‡ä»¶ (onnx ç­‰)
â”‚
â”œâ”€â”€ /tools                      # å·¥ç¨‹å·¥å…·
â”‚   â”œâ”€â”€ launcher.py             # å¯åŠ¨å™¨æºç 
â”‚   â”œâ”€â”€ runtime_hook.py         # PyInstaller è¿è¡Œæ—¶é’©å­
â”‚   â””â”€â”€ build_hooks.py          # PyInstaller è‡ªå®šä¹‰é’©å­
â”‚
â”œâ”€â”€ /tests                      # æµ‹è¯•
â”‚   â”œâ”€â”€ test_idle_monitor.py
â”‚   â”œâ”€â”€ test_ascii_renderer.py
â”‚   â”œâ”€â”€ test_state_machine.py
â”‚   â”œâ”€â”€ test_script_engine.py
â”‚   â””â”€â”€ test_audio_manager.py
â”‚
â”œâ”€â”€ /.github
â”‚   â””â”€â”€ /workflows
â”‚       â””â”€â”€ build.yml           # CI/CD æ„å»ºæµæ°´çº¿
â”‚
â”œâ”€â”€ build.spec                  # PyInstaller æ‰“åŒ…é…ç½®
â”œâ”€â”€ requirements.txt            # å¼€å‘ä¾èµ–
â”œâ”€â”€ requirements-build.txt      # æ‰“åŒ…ä¾èµ–ï¼ˆç²¾ç®€ç‰ˆï¼‰
â”œâ”€â”€ version.json                # ç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€ config.json                 # å…¨å±€é…ç½®
â”œâ”€â”€ LICENSE                     # å¼€æºåè®® (MIT)
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
â””â”€â”€ .gitignore                  # Git å¿½ç•¥è§„åˆ™
```

---

## 5.8 `.gitignore` æ¨èé…ç½®

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.egg-info/
dist/
build/
*.spec.bak

# è™šæ‹Ÿç¯å¢ƒ
.venv/
build_env/
venv/

# IDE
.vscode/
.idea/
*.swp

# æ“ä½œç³»ç»Ÿ
Thumbs.db
.DS_Store

# é¡¹ç›®ç‰¹å®š
characters/*/voice_cache/    # TTS ç¼“å­˜ï¼ˆæ¯ä¸ªç”¨æˆ·æœ¬åœ°ç”Ÿæˆï¼‰
*.log
```

---

## 5.9 `version.json` æ ¼å¼

```json
{
    "version": "1.0.0",
    "build_date": "2026-02-10",
    "python_version": "3.11.7",
    "commit_hash": "abc1234",
    "phase": "Phase 3-MVP"
}
```

---

## ğŸ å…¨æ–‡æ¡£ç»“è¯­ (Conclusion)

è‡³æ­¤ï¼Œ**"Project Cyber-Companion"** çš„å®Œæ•´å¼€å‘æ–‡æ¡£å·²ç»å…¨éƒ¨å®Œæˆã€‚

### æ–‡æ¡£è¦†ç›–æ€»è§ˆ

| Phase | ä¸»é¢˜ | æ ¸å¿ƒäº¤ä»˜ç‰© |
|-------|------|-----------|
| **Phase 1** | æ ¸å¿ƒæ¶æ„ä¸ MVP | IdleMonitor, EntityWindow, AsciiRenderer |
| **Phase 2** | ç¥ç»ä¸è‚Œè‚‰å®ç° | Windows API è§„èŒƒ, åŠ¨ç”»æ›²çº¿, åæ ‡ç³», æ•°æ® Schema |
| **Phase 3** | å£°éŸ³ä¸çµé­‚ | AudioManager, FSM çŠ¶æ€æœº, è„šæœ¬å¼•æ“, è§’è‰²åŒ…è§„èŒƒ |
| **Phase 4** | è§†è§‰æ„ŸçŸ¥ä¸ AI | GazeTracker, PresenceDetector, LLM Provider, MoodSystem |
| **Phase 5** | å·¥ç¨‹åŒ–ä¸å‘å¸ƒ | PyInstaller, CI/CD, è‡ªåŠ¨æ›´æ–°, æ—¥å¿—ç³»ç»Ÿ |

### æŠ€æœ¯æ ˆæ€»è§ˆ

```
åº•å±‚ç³»ç»Ÿé’©å­        â†’ User32.dll (GetLastInputInfo, GetForegroundWindow)
é«˜æ€§èƒ½é€æ˜ GUI     â†’ PySide6 + QPropertyAnimation + HTML Rendering
æƒ…æ„ŸåŒ–è¯­éŸ³åˆæˆ      â†’ edge-tts + Cache-First ç­–ç•¥ + AudioManager
è¡Œä¸ºå¼•æ“           â†’ FSM (æœ‰é™çŠ¶æ€æœº) + æ¦‚ç‡è„šæœ¬å¼•æ“ + å¿ƒæƒ…ç³»ç»Ÿ
è§†è§‰æ„ŸçŸ¥           â†’ MediaPipe Face Mesh + å­˜åœ¨æ£€æµ‹èåˆ
è®¤çŸ¥æ ¸å¿ƒ           â†’ Ollama / OpenAI API + å±å¹• OCR + Prompt Engineering
å·¥ç¨‹åŒ–åˆ†å‘         â†’ PyInstaller + GitHub Actions CI/CD + OTA è‡ªåŠ¨æ›´æ–°
```

### AI å¼€å‘æŒ‡å¯¼è¯´æ˜

æœ¬æ–‡æ¡£ä¸“ä¸º **Claude Code / Copilot / Cursor** ç­‰ AI ç¼–ç¨‹åŠ©æ‰‹è®¾è®¡ï¼š

1. **æ¯ä¸ªç±»éƒ½æœ‰å®Œæ•´çš„ docstring** â€” åŒ…å«èŒè´£è¯´æ˜ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ã€ä½¿ç”¨ç¤ºä¾‹
2. **æ¯ä¸ªæ­¥éª¤éƒ½æœ‰éªŒæ”¶æ ‡å‡†** â€” AI å¯ä»¥æ®æ­¤åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ
3. **ä»£ç éª¨æ¶å¯ç›´æ¥ä½¿ç”¨** â€” AI åªéœ€å¡«å…… `...` å ä½ç¬¦å³å¯å®ç°å®Œæ•´åŠŸèƒ½
4. **ä¾èµ–ç‰ˆæœ¬é”å®š** â€” é¿å…å…¼å®¹æ€§é—®é¢˜
5. **é”™è¯¯å¤„ç†å·²å†…ç½®** â€” æ¯ä¸ªæ¨¡å—éƒ½æœ‰é™çº§ç­–ç•¥ï¼ˆå¦‚ TTS ç¦»çº¿æ—¶é™é»˜è·³è¿‡ï¼‰
6. **æ–‡ä»¶è·¯å¾„æ˜ç¡®** â€” æ¯æ®µä»£ç éƒ½æ ‡æ³¨äº†å¯¹åº”çš„æ–‡ä»¶è·¯å¾„

**æ¨èå¼€å‘é¡ºåº**: Phase 1 Step 1 â†’ Step 2 â†’ Step 3 â†’ Step 4 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4 â†’ Phase 5