# ğŸ“ Project Cyber-Companion å¼€å‘æ–‡æ¡£ (Phase 1)

## â€”â€” æ ¸å¿ƒæ¶æ„ä¸ MVP è®¾è®¡

---

## 1.0 äº§å“æ„¿æ™¯ (Vision)

æ‰“é€ ä¸€ä¸ª**éä¾µå…¥å¼ã€æœ‰ç”Ÿå‘½æ„Ÿçš„ Windows æ¡Œé¢ä¼´ä¾£**ã€‚

### æ ¸å¿ƒå®šä¹‰

| å±æ€§ | æè¿° |
|------|------|
| **å­˜åœ¨æ–¹å¼** | ç”Ÿæ´»åœ¨å±å¹•è¾¹ç¼˜çš„æ•°å­—ç”Ÿå‘½ï¼Œä¸æ˜¯ä¼ ç»Ÿ"ç¨‹åºçª—å£" |
| **è§¦å‘æœºåˆ¶** | ç”¨æˆ·ç¦»å¸­ï¼ˆIdleï¼‰æ—¶è‡ªåŠ¨å‡ºç°ï¼Œç”¨æˆ·å›å½’æ—¶è‡ªåŠ¨éšè— |
| **è¡¨ç°å½¢å¼** | è§†è§‰ï¼ˆå½©è‰² ASCII åŠ¨ç”»ï¼‰+ å¬è§‰ï¼ˆTTS è¯­éŸ³åˆæˆï¼‰ |
| **å¹³å°** | Windows 10/11ï¼Œæ”¯æŒé«˜ DPI æ˜¾ç¤º |
| **æ½œè¡Œèƒ½åŠ›** | å¹³æ—¶å®Œå…¨ä¸å¯è§ï¼Œä¸åœ¨ä»»åŠ¡æ æ˜¾ç¤ºï¼Œä¸å¹²æ‰°ç”¨æˆ·æ“ä½œ |

### ç”¨æˆ·ä½“éªŒåœºæ™¯

1. ç”¨æˆ·ç¦»å¼€ç”µè„‘ 3 åˆ†é’Ÿ â†’ ä¸€ä¸ªå½©è‰² ASCII è§’è‰²ä»å±å¹•è¾¹ç¼˜æ¢å‡ºå¤´
2. è§’è‰²è¯´ä¸€å¥ç¬¦åˆå½“å‰æ—¶æ®µçš„å°è¯ï¼ˆå¦‚æ·±å¤œï¼š"è¿˜ä¸ç¡å—ï¼Ÿ"ï¼‰
3. ç”¨æˆ·å›æ¥è§¦æ‘¸é¼ æ ‡/é”®ç›˜ â†’ è§’è‰²åšå‡ºæƒŠå“è¡¨æƒ…å¹¶è¿…é€Ÿç¼©å›å±å¹•å¤–
4. è§’è‰²æ¶ˆå¤±ï¼Œç³»ç»Ÿæ¢å¤å®Œå…¨éšå½¢çŠ¶æ€

---

## 1.1 æŠ€æœ¯æ ˆé€‰å‹ (Tech Stack)

### ç²¾ç¡®ä¾èµ–æ¸…å•

```txt
# requirements.txt (Phase 1 MVP)
PySide6>=6.6.0,<7.0.0          # Qt for Python - GUI æ¡†æ¶
Pillow>=10.0.0,<11.0.0         # å›¾åƒå¤„ç†
numpy>=1.24.0,<2.0.0           # çŸ©é˜µè®¡ç®—ï¼ˆå›¾ç‰‡è½¬ ASCIIï¼‰
edge-tts>=6.1.0                # å¾®è½¯ Edge è¯­éŸ³åˆæˆ
pywin32>=306                    # Windows API è°ƒç”¨
```

### é€‰å‹ç†ç”±

| ç»„ä»¶ | é€‰å‹ | ç†ç”± |
|------|------|------|
| **GUI æ¡†æ¶** | PySide6 | æ¯” PyQt5 é«˜åˆ†å±æ”¯æŒæ›´å¥½ï¼›Qt å®˜æ–¹ç»´æŠ¤ï¼›LGPL è®¸å¯è¯å¯¹ä¸ªäººå¼€å‘å‹å¥½ï¼›å†…ç½® `QPropertyAnimation` åŠ¨ç”»æ¡†æ¶ |
| **ç³»ç»Ÿäº¤äº’** | `ctypes` + `pywin32` | ç›´æ¥è°ƒç”¨ `User32.dll` è·å–ç³»ç»Ÿç©ºé—²æ—¶é—´ï¼Œé›¶å»¶è¿Ÿï¼Œæ— éœ€é¢å¤–ä¾èµ– |
| **å›¾åƒå¤„ç†** | `Pillow` + `NumPy` | æˆç†Ÿç¨³å®šï¼Œé«˜æ•ˆå¤„ç†å›¾ç‰‡ â†’ ASCII çŸ©é˜µç®—æ³• |
| **è¯­éŸ³åˆæˆ** | `edge-tts` | å…è´¹ã€æ•ˆæœæä½³ï¼ˆæ”¯æŒä¸­æ–‡è‡ªç„¶è¯­éŸ³ï¼‰ã€å¼‚æ­¥æ¥å£ |
| **è¿›ç¨‹ç®¡ç†** | `threading` / `asyncio` | ä¿è¯ GUI ä¸»çº¿ç¨‹ä¸å¡é¡¿ï¼Œåå°ç›‘æ§é€»è¾‘ç‹¬ç«‹è¿è¡Œ |

### Python ç‰ˆæœ¬è¦æ±‚

```
Python >= 3.10, < 3.13
```

> **æ³¨æ„**ï¼šPython 3.10+ æ˜¯å› ä¸ºéœ€è¦ `match-case` è¯­æ³•å’Œ PySide6 çš„å…¼å®¹æ€§ã€‚é¿å… 3.13 æ˜¯å› ä¸º PyInstaller å¯¹æœ€æ–°ç‰ˆæ”¯æŒå¯èƒ½ä¸ç¨³å®šã€‚

---

## 1.2 æ ¸å¿ƒæ¨¡å—æ¶æ„ (Architecture)

### ä¸‰å±‚æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å±‚çº§ C: è¡¨ç°å±‚ (The Body)                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  AsciiRenderer  â”‚    â”‚    EntityWindow (QWidget) â”‚       â”‚
â”‚   â”‚  (è§†è§‰å¼•æ“)      â”‚    â”‚    (é€æ˜æ— è¾¹æ¡†çª—å£)         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚            â”‚                         â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚    å±‚çº§ B: å†³ç­–å±‚ (The Brain)                    â”‚
â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”¤ Director (å¯¼æ¼”)    â”‚â”˜                      â”‚
â”‚                 â”‚  - è°ƒåº¦èµ„æº         â”‚                       â”‚
â”‚                 â”‚  - é€‰æ‹©å°è¯/åŠ¨ç”»    â”‚                       â”‚
â”‚                 â”‚  - æŒ‡æŒ¥æ¸²æŸ“å±‚       â”‚                       â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          â”‚   å±‚çº§ A: æ„ŸçŸ¥å±‚ (The Senses)      â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                 â”‚ IdleMonitor        â”‚                       â”‚
â”‚                 â”‚ (Daemon Thread)    â”‚                       â”‚
â”‚                 â”‚  - GetLastInputInfoâ”‚                       â”‚
â”‚                 â”‚  - çŠ¶æ€æœºç®¡ç†       â”‚                       â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿¡å·æµ (Signal Flow)

```
IdleMonitor â”€â”€[Signal: user_idle_confirmed]â”€â”€â–º Director
IdleMonitor â”€â”€[Signal: user_active_detected]â”€â”€â–º Director
Director â”€â”€[è°ƒç”¨: show_entity(pos, script)]â”€â”€â–º EntityWindow
Director â”€â”€[è°ƒç”¨: hide_entity(anim_type)]â”€â”€â–º EntityWindow
Director â”€â”€[è°ƒç”¨: play_audio(file_path)]â”€â”€â–º AudioManager
```

---

## 1.3 å±‚çº§ A: æ„ŸçŸ¥å±‚ (The Senses) â€” è¯¦ç»†è®¾è®¡

### IdleMonitor ç±»å®šä¹‰

```python
# src/core/idle_monitor.py

import ctypes
import ctypes.wintypes
import time
from PySide6.QtCore import QThread, Signal


class LASTINPUTINFO(ctypes.Structure):
    """
    Windows API ç»“æ„ä½“ï¼šLASTINPUTINFO
    æ–‡æ¡£: https://learn.microsoft.com/en-us/windows/win32/api/winuser/ns-winuser-lastinputinfo
    """
    _fields_ = [
        ("cbSize", ctypes.wintypes.UINT),  # ç»“æ„ä½“å¤§å°ï¼Œå¿…é¡»åˆå§‹åŒ–ä¸º 8
        ("dwTime", ctypes.wintypes.DWORD), # æœ€åä¸€æ¬¡è¾“å…¥äº‹ä»¶çš„ç³»ç»Ÿ Tick Count
    ]


class IdleState:
    """ç©ºé—²çŠ¶æ€æšä¸¾"""
    STANDBY = "STANDBY"           # å¾…å‘½ï¼šç”¨æˆ·æ´»è·ƒï¼Œç­‰å¾…ç©ºé—²
    PRE_IDLE = "PRE_IDLE"         # é¢„ç©ºé—²ï¼šæ¥è¿‘é˜ˆå€¼ï¼Œå¯åšé¢„åŠ è½½
    IDLE_TRIGGERED = "IDLE_TRIGGERED"  # å·²è§¦å‘ï¼šè¶…è¿‡é˜ˆå€¼
    ACTIVE = "ACTIVE"             # æ´»è·ƒä¸­ï¼šè§’è‰²æ­£åœ¨æ˜¾ç¤ºæ—¶ç”¨æˆ·å›æ¥äº†


class IdleMonitor(QThread):
    """
    ç©ºé—²ç›‘æ§å™¨ â€” åå°å®ˆæŠ¤çº¿ç¨‹
    
    èŒè´£ï¼š
    - æ¯ 100ms è½®è¯¢ Windows API GetLastInputInfo()
    - è®¡ç®—ç”¨æˆ·ç©ºé—²æ—¶é—´
    - æ ¹æ®çŠ¶æ€æœºå‘å‡ºå¯¹åº”ä¿¡å·
    
    ä¿¡å·ï¼š
    - user_idle_confirmed: ç”¨æˆ·ç©ºé—²è¶…è¿‡é˜ˆå€¼
    - user_active_detected: ç”¨æˆ·ä»ç©ºé—²çŠ¶æ€æ¢å¤æ“ä½œ
    - idle_time_updated(int): å®æ—¶ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œç”¨äºè°ƒè¯•
    """
    
    user_idle_confirmed = Signal()
    user_active_detected = Signal()
    idle_time_updated = Signal(int)  # è°ƒè¯•ç”¨ï¼šå®æ—¶å‘é€ç©ºé—²æ¯«ç§’æ•°
    
    # â”€â”€ é…ç½®å¸¸é‡ â”€â”€
    POLL_INTERVAL_MS: int = 100        # è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    DEFAULT_THRESHOLD_MS: int = 180000 # é»˜è®¤ç©ºé—²é˜ˆå€¼ï¼ˆ3åˆ†é’Ÿ = 180,000msï¼‰
    PRE_IDLE_RATIO: float = 0.8        # é¢„ç©ºé—²æ¯”ä¾‹ï¼ˆ80% é˜ˆå€¼æ—¶è¿›å…¥é¢„ç©ºé—²ï¼‰
    ACTIVE_RESET_MS: int = 1000        # æ´»è·ƒé‡ç½®é˜ˆå€¼ï¼ˆ1ç§’å†…æœ‰è¾“å…¥è§†ä¸ºæ´»è·ƒï¼‰
    
    def __init__(self, threshold_ms: int = DEFAULT_THRESHOLD_MS, parent=None):
        super().__init__(parent)
        self._threshold_ms = threshold_ms
        self._state = IdleState.STANDBY
        self._running = False
        self._user32 = ctypes.windll.user32
        self._kernel32 = ctypes.windll.kernel32
    
    def run(self) -> None:
        """ä¸»è½®è¯¢å¾ªç¯ â€” åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œ"""
        self._running = True
        while self._running:
            idle_ms = self._get_idle_time_ms()
            self.idle_time_updated.emit(idle_ms)
            self._update_state(idle_ms)
            self.msleep(self.POLL_INTERVAL_MS)
    
    def stop(self) -> None:
        """å®‰å…¨åœæ­¢çº¿ç¨‹"""
        self._running = False
        self.wait(2000)  # ç­‰å¾…æœ€å¤š 2 ç§’
    
    def _get_idle_time_ms(self) -> int:
        """
        è°ƒç”¨ Windows API è·å–ç©ºé—²æ—¶é—´
        
        è¿”å›å€¼: ç©ºé—²æ¯«ç§’æ•°
        
        æ³¨æ„: GetTickCount() åœ¨ç³»ç»Ÿè¿è¡Œ 49.7 å¤©åä¼šæº¢å‡ºï¼ˆDWORD ä¸Šé™ï¼‰ã€‚
        ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ GetTickCount64() æ›¿ä»£ã€‚
        """
        lii = LASTINPUTINFO()
        lii.cbSize = ctypes.sizeof(LASTINPUTINFO)
        
        if not self._user32.GetLastInputInfo(ctypes.byref(lii)):
            return 0  # API è°ƒç”¨å¤±è´¥ï¼Œå®‰å…¨é€€å‡º
        
        current_tick = self._kernel32.GetTickCount()
        idle_time = current_tick - lii.dwTime
        
        # å¤„ç† GetTickCount æº¢å‡ºï¼ˆçº¦ 49.7 å¤©åï¼‰
        if idle_time < 0:
            idle_time += 0xFFFFFFFF
        
        return idle_time
    
    def _update_state(self, idle_ms: int) -> None:
        """
        æœ‰é™çŠ¶æ€æœº (FSM) â€” çŠ¶æ€æµè½¬é€»è¾‘
        
        çŠ¶æ€è½¬æ¢å›¾:
        STANDBY â”€â”€(idle > threshold)â”€â”€â–º IDLE_TRIGGERED â”€â”€(input detected)â”€â”€â–º ACTIVE â”€â”€(åŠ¨ç”»å®Œæˆ)â”€â”€â–º STANDBY
                â”€â”€(idle > 80% threshold)â”€â”€â–º PRE_IDLE â”€â”€(idle > threshold)â”€â”€â–º IDLE_TRIGGERED
                                                     â”€â”€(input detected)â”€â”€â–º STANDBY
        """
        match self._state:
            case IdleState.STANDBY:
                if idle_ms >= self._threshold_ms:
                    self._state = IdleState.IDLE_TRIGGERED
                    self.user_idle_confirmed.emit()
                elif idle_ms >= self._threshold_ms * self.PRE_IDLE_RATIO:
                    self._state = IdleState.PRE_IDLE
                    
            case IdleState.PRE_IDLE:
                if idle_ms >= self._threshold_ms:
                    self._state = IdleState.IDLE_TRIGGERED
                    self.user_idle_confirmed.emit()
                elif idle_ms < self.ACTIVE_RESET_MS:
                    self._state = IdleState.STANDBY
                    
            case IdleState.IDLE_TRIGGERED:
                if idle_ms < self.ACTIVE_RESET_MS:
                    self._state = IdleState.ACTIVE
                    self.user_active_detected.emit()
                    
            case IdleState.ACTIVE:
                # ACTIVE çŠ¶æ€ç­‰å¾…å¤–éƒ¨ï¼ˆDirectorï¼‰é€šçŸ¥åŠ¨ç”»å®Œæˆåå›åˆ° STANDBY
                if idle_ms >= self._threshold_ms:
                    self._state = IdleState.IDLE_TRIGGERED
                    self.user_idle_confirmed.emit()
    
    def reset_to_standby(self) -> None:
        """å¤–éƒ¨è°ƒç”¨ï¼šé€šçŸ¥åŠ¨ç”»å®Œæˆï¼Œå›åˆ°å¾…å‘½çŠ¶æ€"""
        self._state = IdleState.STANDBY
```

### IdleMonitor éªŒæ”¶æ ‡å‡† (Done Criteria)

| # | éªŒæ”¶é¡¹ | æµ‹è¯•æ–¹æ³• |
|---|--------|---------|
| 1 | æ§åˆ¶å°èƒ½å®æ—¶æ‰“å°ç©ºé—²æ—¶é—´ | è¿è¡Œè„šæœ¬ï¼Œè§‚å¯Ÿè¾“å‡º `"ç”¨æˆ·å·²ç©ºé—²: 10s... 20s..."` |
| 2 | 3 åˆ†é’Ÿä¸æ“ä½œåè§¦å‘ `user_idle_confirmed` ä¿¡å· | è¿æ¥ä¿¡å·åˆ° printï¼Œç­‰å¾…è§¦å‘ |
| 3 | è§¦å‘åç§»åŠ¨é¼ æ ‡ï¼Œ`user_active_detected` ä¿¡å·è§¦å‘ | è¿æ¥ä¿¡å·åˆ° printï¼Œæ‰‹åŠ¨æ“ä½œéªŒè¯ |
| 4 | ä¸é˜»å¡ä¸»çº¿ç¨‹ | åœ¨ GUI åº”ç”¨ä¸­é›†æˆï¼Œç¡®è®¤ç•Œé¢ä¸å¡é¡¿ |
| 5 | CPU å ç”¨ç‡ < 1% | ä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨è§‚å¯Ÿ |

---

## 1.4 å±‚çº§ B: å†³ç­–å±‚ (The Brain) â€” è¯¦ç»†è®¾è®¡

### Director ç±»å®šä¹‰

```python
# src/core/director.py

import random
import json
from datetime import datetime
from pathlib import Path
from PySide6.QtCore import QObject, Slot
from PySide6.QtWidgets import QApplication


class ScreenEdge:
    """å±å¹•è¾¹ç¼˜æšä¸¾"""
    RIGHT = "right"
    LEFT = "left"
    TOP = "top"
    BOTTOM = "bottom"


class Director(QObject):
    """
    å¯¼æ¼”æ§åˆ¶å™¨ â€” æ¥æ”¶æ„ŸçŸ¥å±‚ä¿¡å·ï¼ŒæŒ‡æŒ¥è¡¨ç°å±‚
    
    èŒè´£ï¼š
    1. æ¥æ”¶ IdleMonitor çš„ä¿¡å·
    2. éšæœºå†³å®šè§’è‰²å‡ºåœºæ–¹å‘å’Œä½ç½®
    3. æ ¹æ®æ—¶æ®µé€‰æ‹©å°è¯
    4. è°ƒç”¨ TTS ç”ŸæˆéŸ³é¢‘
    5. å‘½ä»¤ EntityWindow æ‰§è¡ŒåŠ¨ç”»
    
    ä¾èµ–ï¼š
    - IdleMonitor: ä¿¡å·æº
    - EntityWindow: æ¸²æŸ“ç›®æ ‡
    - AudioManager: éŸ³é¢‘æ’­æ”¾
    - AssetManager: èµ„æºç®¡ç†
    """
    
    def __init__(self, entity_window, audio_manager, asset_manager, parent=None):
        super().__init__(parent)
        self._entity_window = entity_window
        self._audio_manager = audio_manager
        self._asset_manager = asset_manager
    
    @Slot()
    def on_user_idle(self) -> None:
        """
        ç”¨æˆ·ç©ºé—²æ—¶çš„å¤„ç†é€»è¾‘
        
        æ‰§è¡Œæµç¨‹ï¼š
        1. è·å–å±å¹•å°ºå¯¸
        2. éšæœºé€‰æ‹©å‡ºåœºè¾¹ç¼˜å’Œåæ ‡
        3. ä» AssetManager è·å–å½“å‰æ—¶æ®µå°è¯
        4. ç”Ÿæˆ/è·å– TTS éŸ³é¢‘
        5. å‘½ä»¤ EntityWindow æ‰§è¡Œæ»‘å…¥åŠ¨ç”»
        """
        screen = QApplication.primaryScreen().geometry()
        edge = random.choice([ScreenEdge.RIGHT, ScreenEdge.LEFT])
        
        # è®¡ç®—å‡ºåœºåæ ‡ï¼ˆåœ¨å±å¹•è¾¹ç¼˜é«˜åº¦çš„ 20%-80% èŒƒå›´å†…éšæœºï¼‰
        y_pos = random.randint(
            int(screen.height() * 0.2),
            int(screen.height() * 0.8)
        )
        
        # è·å–å½“å‰æ—¶æ®µçš„å°è¯
        script = self._asset_manager.get_script_for_time(datetime.now())
        
        # å‘½ä»¤ EntityWindow å¼€å§‹å‡ºåœºåŠ¨ç”»åºåˆ—
        self._entity_window.summon(edge=edge, y_position=y_pos, script=script)
    
    @Slot()
    def on_user_active(self) -> None:
        """
        ç”¨æˆ·å›å½’æ—¶çš„å¤„ç†é€»è¾‘
        
        æ‰§è¡Œæµç¨‹ï¼š
        1. ç«‹å³ä¸­æ–­å½“å‰åŠ¨ç”»å’ŒéŸ³é¢‘
        2. å‘½ä»¤ EntityWindow æ‰§è¡ŒæƒŠå“/é€ƒè·‘åŠ¨ç”»
        3. åŠ¨ç”»å®Œæˆåéšè—çª—å£
        """
        self._audio_manager.interrupt()
        self._entity_window.flee()
```

### AssetManager æ¥å£å®šä¹‰

```python
# src/core/asset_manager.py

from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Optional


@dataclass
class Script:
    """å°è¯æ•°æ®æ¨¡å‹"""
    id: str                    # å°è¯å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ "midnight_greet_01"
    text: str                  # å°è¯æ–‡æœ¬
    audio_path: Optional[str]  # é¢„ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
    anim_speed: str            # åŠ¨ç”»é€Ÿåº¦: "slow", "normal", "fast"
    priority: int              # ä¼˜å…ˆçº§: 1=é«˜, 2=ä¸­, 3=ä½


class AssetManager:
    """
    èµ„æºç®¡ç†å™¨
    
    èŒè´£ï¼š
    - åŠ è½½è§’è‰²èµ„æºåŒ…
    - æ ¹æ®æ—¶é—´æ®µæŸ¥è¯¢å°è¯
    - ç®¡ç†é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€éŸ³æ•ˆï¼‰è·¯å¾„
    """
    
    def __init__(self, character_dir: Path):
        """
        å‚æ•°:
            character_dir: è§’è‰²èµ„æºåŒ…æ ¹ç›®å½•ï¼Œå¦‚ characters/rem_maid/
        """
        self._character_dir = character_dir
        self._scripts: list[Script] = []
        self._load_scripts()
    
    def _load_scripts(self) -> None:
        """ä» scripts.json åŠ è½½å°è¯åº“"""
        # å®ç°: è¯»å– JSON å¹¶è§£æä¸º Script å¯¹è±¡åˆ—è¡¨
        ...
    
    def get_script_for_time(self, now: datetime) -> Script:
        """
        æ ¹æ®å½“å‰æ—¶é—´è·å–åˆé€‚çš„å°è¯
        
        åŒ¹é…è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
        1. ç²¾ç¡®åŒ¹é…å½“å‰æ—¶é—´èŒƒå›´çš„å°è¯
        2. åŒ¹é… "default" æ—¶é—´èŒƒå›´çš„å°è¯
        3. å¦‚æœæœ‰å¤šä¸ªåŒ¹é…ï¼Œæ ¹æ® probability å­—æ®µéšæœºé€‰æ‹©
        
        å‚æ•°:
            now: å½“å‰æ—¶é—´
        
        è¿”å›:
            åŒ¹é…çš„ Script å¯¹è±¡
        """
        ...
```

---

## 1.5 å±‚çº§ C: è¡¨ç°å±‚ (The Body) â€” è¯¦ç»†è®¾è®¡

### AsciiRenderer ç±»å®šä¹‰

```python
# src/ui/ascii_renderer.py

import numpy as np
from PIL import Image
from pathlib import Path


class AsciiRenderer:
    """
    ASCII æ¸²æŸ“å¼•æ“
    
    èŒè´£ï¼š
    - å°†å›¾ç‰‡è½¬æ¢ä¸ºå½©è‰² HTML ASCII å­—ç¬¦ä¸²
    - å¤„ç†é€æ˜åº¦é®ç½©ï¼ˆè‡ªåŠ¨æ‰£é™¤èƒŒæ™¯è‰²ï¼‰
    - è¾“å‡ºå¯ç›´æ¥æ”¾å…¥ QLabel çš„ HTML å¯Œæ–‡æœ¬
    
    æ¸²æŸ“æµç¨‹ï¼š
    1. åŠ è½½å›¾ç‰‡ â†’ PIL.Image
    2. é™é‡‡æ · â†’ resize åˆ°ç›®æ ‡å­—ç¬¦æ•°
    3. éå†åƒç´  â†’ ç°åº¦æ˜ å°„åˆ° ASCII å­—ç¬¦
    4. é¢œè‰²æ˜ å°„ â†’ æ¯ä¸ªå­—ç¬¦é™„å¸¦ HTML <span> é¢œè‰²
    5. é€æ˜é®ç½© â†’ èƒŒæ™¯è‰²åƒç´ æ›¿æ¢ä¸º &nbsp;
    """
    
    # ASCII å­—ç¬¦é›†ï¼šä»å¯†åˆ°ç–ï¼ˆæš— â†’ äº®ï¼‰
    CHARSET: str = "@%#*+=-:. "
    
    # ç­‰å®½å­—ä½“çš„é«˜å®½æ¯”ä¿®æ­£ç³»æ•°ï¼ˆé˜²æ­¢ ASCII ç”»è¢«çºµå‘æ‹‰ä¼¸ï¼‰
    ASPECT_RATIO_CORRECTION: float = 0.55
    
    # èƒŒæ™¯è‰²åˆ¤å®šé˜ˆå€¼ï¼ˆR+G+B ä¹‹å’Œä½äºæ­¤å€¼è§†ä¸ºèƒŒæ™¯ï¼‰
    BG_THRESHOLD: int = 30
    
    def __init__(self, width: int = 80):
        """
        å‚æ•°:
            width: è¾“å‡º ASCII ç”»çš„å­—ç¬¦å®½åº¦ï¼ˆåˆ—æ•°ï¼‰
        """
        self._width = width
    
    def render_image(self, image_path: Path) -> str:
        """
        å°†å›¾ç‰‡æ–‡ä»¶æ¸²æŸ“ä¸º HTML ASCII å­—ç¬¦ä¸²
        
        å‚æ•°:
            image_path: å›¾ç‰‡æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒ PNG/JPG/GIF å•å¸§ï¼‰
        
        è¿”å›:
            HTML å¯Œæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚:
            <pre style="font-family: Consolas, monospace; font-size: 8px; line-height: 1.0;">
            <span style="color: rgb(255,200,180);">@</span>
            <span style="color: rgb(100,50,20);">#</span>
            ...
            </pre>
        
        å¼‚å¸¸:
            FileNotFoundError: å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨
            ValueError: å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ
        """
        ...
    
    def render_gif_frames(self, gif_path: Path) -> list[str]:
        """
        å°† GIF åŠ¨ç”»çš„æ¯ä¸€å¸§æ¸²æŸ“ä¸º HTML ASCII å­—ç¬¦ä¸²åˆ—è¡¨
        
        å‚æ•°:
            gif_path: GIF æ–‡ä»¶è·¯å¾„
            
        è¿”å›:
            HTML å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€å¸§
        """
        ...
    
    def _pixel_to_char(self, r: int, g: int, b: int) -> tuple[str, bool]:
        """
        å•åƒç´  â†’ ASCII å­—ç¬¦è½¬æ¢
        
        å‚æ•°:
            r, g, b: åƒç´  RGB å€¼ (0-255)
        
        è¿”å›:
            (å­—ç¬¦, æ˜¯å¦é€æ˜) å…ƒç»„
            - å­—ç¬¦: æ˜ å°„åçš„ ASCII å­—ç¬¦
            - æ˜¯å¦é€æ˜: True è¡¨ç¤ºè¯¥åƒç´ åº”è¢«è§†ä¸ºèƒŒæ™¯
        
        æ˜ å°„ç®—æ³•:
            1. åˆ¤æ–­é€æ˜: R+G+B < BG_THRESHOLD â†’ è¿”å› ("&nbsp;", True)
            2. è®¡ç®—ç°åº¦: Gray = 0.299*R + 0.587*G + 0.114*B
            3. æ˜ å°„å­—ç¬¦: index = int(Gray / 255 * (len(CHARSET) - 1))
            4. è¿”å›: (CHARSET[index], False)
        """
        ...
```

### EntityWindow ç±»å®šä¹‰

```python
# src/ui/entity_window.py

from PySide6.QtWidgets import QWidget, QLabel, QVBoxLayout
from PySide6.QtCore import (
    Qt, QPropertyAnimation, QEasingCurve, 
    QPoint, QSequentialAnimationGroup, QTimer
)
from PySide6.QtGui import QFont


class EntityWindow(QWidget):
    """
    å®ä½“çª—å£ â€” è§’è‰²çš„ç‰©ç†è½½ä½“
    
    çª—å£å±æ€§ï¼š
    - æ— è¾¹æ¡† (FramelessWindowHint)
    - æ€»åœ¨æœ€å‰ (WindowStaysOnTopHint)
    - èƒŒæ™¯é€æ˜ (WA_TranslucentBackground)
    - ä¸æ˜¾ç¤ºä»»åŠ¡æ å›¾æ ‡ (Tool)
    
    èŒè´£ï¼š
    - æ˜¾ç¤º ASCII å­—ç¬¦ç”»ï¼ˆé€šè¿‡ QLabel + HTMLï¼‰
    - æ‰§è¡Œæ»‘å…¥/æ»‘å‡ºåŠ¨ç”»
    - ç®¡ç†åŠ¨ç”»é˜Ÿåˆ—
    """
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self._setup_window_flags()
        self._setup_ui()
        self._setup_animations()
    
    def _setup_window_flags(self) -> None:
        """
        è®¾ç½®çª—å£æ ‡å¿—ä½
        
        å…³é”®æ ‡å¿—:
        - Qt.FramelessWindowHint: å»é™¤æ ‡é¢˜æ å’Œè¾¹æ¡†
        - Qt.WindowStaysOnTopHint: ç½®é¡¶æ˜¾ç¤º
        - Qt.Tool: ä¸åœ¨ä»»åŠ¡æ æ˜¾ç¤º
        - Qt.WA_TranslucentBackground: èƒŒæ™¯é€æ˜
        - Qt.WA_ShowWithoutActivating: æ˜¾ç¤ºæ—¶ä¸æŠ¢å¤ºç„¦ç‚¹
        """
        self.setWindowFlags(
            Qt.WindowType.FramelessWindowHint
            | Qt.WindowType.WindowStaysOnTopHint
            | Qt.WindowType.Tool
        )
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground, True)
        self.setAttribute(Qt.WidgetAttribute.WA_ShowWithoutActivating, True)
    
    def _setup_ui(self) -> None:
        """
        åˆå§‹åŒ– UI ç»„ä»¶
        
        æ ¸å¿ƒç»„ä»¶:
        - QLabel: æ˜¾ç¤º HTML æ ¼å¼çš„ ASCII å­—ç¬¦ç”»
        - å­—ä½“: å¿…é¡»ä½¿ç”¨ç­‰å®½å­—ä½“ (Consolas/Courier New)
        """
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        
        self._label = QLabel()
        self._label.setTextFormat(Qt.TextFormat.RichText)
        self._label.setFont(QFont("Consolas", 8))
        self._label.setStyleSheet("background: transparent;")
        layout.addWidget(self._label)
    
    def _setup_animations(self) -> None:
        """
        åˆå§‹åŒ–åŠ¨ç”»ç³»ç»Ÿ
        
        åŠ¨ç”»ç±»å‹:
        - slide_in: æ»‘å…¥åŠ¨ç”» (OutBack æ›²çº¿, 1.5s)
        - slide_out: æ»‘å‡ºåŠ¨ç”» (InExpo æ›²çº¿, 0.3s)
        - peek: æ¢å¤´åŠ¨ç”» (OutBack æ›²çº¿, 0.8s)
        """
        self._slide_anim = QPropertyAnimation(self, b"pos")
    
    def summon(self, edge: str, y_position: int, script) -> None:
        """
        å¬å”¤è§’è‰²å‡ºåœº
        
        åŠ¨ç”»åºåˆ—:
        1. è®¾ç½®åˆå§‹ä½ç½®ï¼ˆå±å¹•å¤–ï¼‰
        2. æ˜¾ç¤ºçª—å£
        3. æ’­æ”¾æ»‘å…¥åŠ¨ç”»
        
        å‚æ•°:
            edge: å‡ºåœºè¾¹ç¼˜ ("left" / "right")
            y_position: å‚ç›´ä½ç½®ï¼ˆåƒç´ ï¼‰
            script: å°è¯å¯¹è±¡
        """
        ...
    
    def flee(self) -> None:
        """
        è§’è‰²é€ƒè·‘
        
        åŠ¨ç”»åºåˆ—:
        1. åœæ­¢å½“å‰åŠ¨ç”»
        2. æ’­æ”¾å¿«é€Ÿæ»‘å‡ºåŠ¨ç”» (InExpo, 0.3s)
        3. åŠ¨ç”»å®Œæˆåéšè—çª—å£
        """
        ...
    
    def set_ascii_content(self, html: str) -> None:
        """
        æ›´æ–°æ˜¾ç¤ºå†…å®¹
        
        å‚æ•°:
            html: AsciiRenderer ç”Ÿæˆçš„ HTML å­—ç¬¦ä¸²
        """
        self._label.setText(html)
        self.adjustSize()
```

---

## 1.6 é«˜ DPI é€‚é… (High DPI Support)

### é—®é¢˜æè¿°

Windows ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¦‚ 125%ã€150%ï¼‰ä¼šå¯¼è‡´ï¼š
1. ASCII å­—ç¬¦ç”»æ¨¡ç³Š
2. çª—å£åæ ‡åç§»
3. å­—ä½“æ¸²æŸ“å¼‚å¸¸

### è§£å†³æ–¹æ¡ˆ

åœ¨ `main.py` å…¥å£æ–‡ä»¶çš„æœ€å¼€å¤´ï¼ˆä»»ä½• Qt å¯¼å…¥ä¹‹å‰ï¼‰ï¼š

```python
# src/main.py â€” å¿…é¡»åœ¨æœ€é¡¶éƒ¨

import os
import sys

# â”€â”€ é«˜ DPI é€‚é… â”€â”€ å¿…é¡»åœ¨ QApplication åˆ›å»ºä¹‹å‰è®¾ç½® â”€â”€
os.environ["QT_ENABLE_HIGHDPI_SCALING"] = "1"
os.environ["QT_SCALE_FACTOR_ROUNDING_POLICY"] = "PassThrough"

from PySide6.QtWidgets import QApplication
from PySide6.QtCore import Qt

def main():
    app = QApplication(sys.argv)
    
    # ç¡®ä¿ä½¿ç”¨é€»è¾‘åƒç´ è€Œéç‰©ç†åƒç´ è¿›è¡Œåæ ‡è®¡ç®—
    # è·å–å±å¹•æ—¶ä½¿ç”¨ screen.availableGeometry() è€Œéç¡¬ç¼–ç åˆ†è¾¨ç‡
    
    # ... åˆå§‹åŒ–å„æ¨¡å— ...
    
    sys.exit(app.exec())

if __name__ == "__main__":
    main()
```

---

## 1.7 Phase 1 å¼€å‘è·¯çº¿å›¾ (MVP Roadmap)

### ä¸¥æ ¼æ‰§è¡Œé¡ºåº

> âš ï¸ **æ¯ä¸ª Step å¿…é¡»å®Œæˆæ‰€æœ‰éªŒæ”¶æ ‡å‡†åæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ª Step**

#### Step 1: æ‰“é€ "å¹½çµçª—å£" (The Ghost Window)

**æ–‡ä»¶**: `src/ui/entity_window.py`, `src/ui/ascii_renderer.py`

**ç›®æ ‡**: å®ç°ä¸€ä¸ªèƒ½åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„ã€é€æ˜èƒŒæ™¯çš„é™æ€å½©è‰² ASCII çª—å£ã€‚

**å®ç°è¦ç‚¹**:
1. åˆ›å»º `EntityWindow` ç±»ï¼Œè®¾ç½®æ‰€æœ‰çª—å£æ ‡å¿—ä½
2. åˆ›å»º `AsciiRenderer` ç±»ï¼Œå®ç°å›¾ç‰‡ â†’ HTML ASCII è½¬æ¢
3. å®ç°"é»‘è‰²èƒŒæ™¯è‡ªåŠ¨æ‰£é™¤"ç®—æ³•ï¼ˆ`_pixel_to_char` æ–¹æ³•ï¼‰
4. å¤„ç†é«˜ DPI ç¼©æ”¾é—®é¢˜

**éªŒæ”¶æ ‡å‡†**:
- [ ] çª—å£æ— è¾¹æ¡†ã€èƒŒæ™¯é€æ˜ã€ç½®é¡¶æ˜¾ç¤º
- [ ] ä¸åœ¨ä»»åŠ¡æ æ˜¾ç¤ºå›¾æ ‡
- [ ] å½©è‰² ASCII å­—ç¬¦ç”»æ­£å¸¸æ˜¾ç¤ºï¼Œæ— æ¨¡ç³Š
- [ ] é»‘è‰²èƒŒæ™¯è¢«æ­£ç¡®æ‰£é™¤ï¼ˆå¯é€è¿‡å­—ç¬¦çœ‹åˆ°æ¡Œé¢å£çº¸ï¼‰
- [ ] åœ¨ 100%ã€125%ã€150% ç¼©æ”¾ä¸‹å‡æ­£å¸¸æ˜¾ç¤º

**æµ‹è¯•ä»£ç **:
```python
# tests/test_ghost_window.py
if __name__ == "__main__":
    app = QApplication(sys.argv)
    renderer = AsciiRenderer(width=60)
    html = renderer.render_image(Path("assets/sprites/test.png"))
    
    window = EntityWindow()
    window.set_ascii_content(html)
    window.move(500, 300)  # æ”¾åœ¨å±å¹•ä¸­å¤®
    window.show()
    
    sys.exit(app.exec())
```

---

#### Step 2: æ¥å…¥"ç¥ç»ç³»ç»Ÿ" (The Idle Detector)

**æ–‡ä»¶**: `src/core/idle_monitor.py`

**ç›®æ ‡**: å®ç° Windows API ç©ºé—²æ£€æµ‹ï¼Œèƒ½åœ¨æ§åˆ¶å°å®æ—¶æ‰“å°ç©ºé—²æ—¶é—´ã€‚

**å®ç°è¦ç‚¹**:
1. åˆ›å»º `IdleMonitor` ç±»ï¼ˆå®Œæ•´ä»£ç è§ 1.3 èŠ‚ï¼‰
2. æ­£ç¡®è°ƒç”¨ `User32.dll` çš„ `GetLastInputInfo`
3. å¤„ç† `GetTickCount` æ—¶é—´æˆ³æº¢å‡ºï¼ˆ49.7 å¤©ä¸Šé™ï¼‰
4. å®ç°çŠ¶æ€æœº (STANDBY â†’ PRE_IDLE â†’ IDLE_TRIGGERED â†’ ACTIVE)

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ§åˆ¶å°æ¯ç§’æ‰“å°ä¸€æ¬¡ç©ºé—²æ—¶é—´ï¼ˆæ ¼å¼: `"ç©ºé—²: 15.3s"`ï¼‰
- [ ] ç©ºé—²è¶…è¿‡è®¾å®šé˜ˆå€¼åè§¦å‘ä¿¡å·
- [ ] é¼ æ ‡/é”®ç›˜æ“ä½œåç«‹å³é‡ç½®è®¡æ—¶
- [ ] åå°çº¿ç¨‹ CPU å ç”¨ < 1%
- [ ] ä¸å½±å“å…¶ä»–åº”ç”¨çš„è¾“å…¥æ¥æ”¶

**æµ‹è¯•ä»£ç **:
```python
# tests/test_idle_monitor.py
if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    monitor = IdleMonitor(threshold_ms=10000)  # 10ç§’é˜ˆå€¼ï¼ˆæµ‹è¯•ç”¨ï¼‰
    monitor.idle_time_updated.connect(
        lambda ms: print(f"ç©ºé—²: {ms/1000:.1f}s")
    )
    monitor.user_idle_confirmed.connect(
        lambda: print(">>> ç”¨æˆ·å·²ç¦»å¼€ï¼")
    )
    monitor.user_active_detected.connect(
        lambda: print(">>> ç”¨æˆ·å›æ¥äº†ï¼")
    )
    monitor.start()
    
    sys.exit(app.exec())
```

---

#### Step 3: èµ‹äºˆ"è¡ŒåŠ¨èƒ½åŠ›" (The Animation)

**æ–‡ä»¶**: `src/ui/entity_window.py` (æ‰©å±• `summon` å’Œ `flee` æ–¹æ³•)

**ç›®æ ‡**: å°† Step 1 å’Œ Step 2 ç»“åˆã€‚çª—å£å¹³æ—¶éšè—ï¼Œç©ºé—²è§¦å‘åä»å±å¹•è¾¹ç¼˜æ»‘å…¥ã€‚

**å®ç°è¦ç‚¹**:
1. ä½¿ç”¨ `QPropertyAnimation` åŠ¨ç”»ç³»ç»Ÿ
2. ä½¿ç”¨ `QEasingCurve.OutBack` æ›²çº¿ï¼ˆå¼¹æ€§æ¢å¤´æ•ˆæœï¼‰
3. ä½¿ç”¨ `QSequentialAnimationGroup` ä¸²è”åŠ¨ç”»åºåˆ—
4. é€ƒè·‘åŠ¨ç”»ä½¿ç”¨ `QEasingCurve.InExpo` æ›²çº¿ï¼ˆæé€Ÿç¼©å›ï¼‰

**åŠ¨ç”»å‚æ•°è¡¨**:

| åŠ¨ç”» | æŒç»­æ—¶é—´ | ç¼“åŠ¨æ›²çº¿ | èµ·ç‚¹ X | ç»ˆç‚¹ X | è¯­ä¹‰ |
|------|---------|----------|--------|--------|------|
| æ¢å¤´ (Peek) | 1500ms | OutBack | ScreenWidth | ScreenWidth - 100 | å°å¿ƒç¿¼ç¿¼æ¢å‡ºå¤´ |
| ç™»åœº (Enter) | 800ms | OutBounce | ScreenWidth - 100 | ScreenWidth - 350 | å¼€å¿ƒè·³å‡ºæ¥ |
| é€ƒè·‘ (Flee) | 300ms | InExpo | å½“å‰ä½ç½® | ScreenWidth | è¢«å‘ç°äº†ï¼èµ¶ç´§æºœ |

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç©ºé—²è§¦å‘åï¼Œçª—å£ä»å±å¹•å³ä¾§ç¼“æ…¢æ¢å‡º
- [ ] æ¢å‡ºååœé¡¿ 2 ç§’ï¼Œç„¶åå®Œå…¨æ»‘å…¥
- [ ] ç§»åŠ¨é¼ æ ‡åï¼Œçª—å£æé€Ÿç¼©å›å¹¶éšè—
- [ ] åŠ¨ç”»æµç•…æ— å¡é¡¿ï¼ˆâ‰¥ 60fpsï¼‰
- [ ] åŠ¨ç”»è¿‡ç¨‹ä¸­ä¸å½±å“å…¶ä»–åº”ç”¨æ“ä½œ

---

#### Step 4: èµ‹äºˆ"å£°éŸ³" (The Voice)

**æ–‡ä»¶**: `src/core/audio_manager.py`

**ç›®æ ‡**: æ¥å…¥ `edge-tts` è¯­éŸ³åˆæˆï¼Œè§’è‰²å‡ºåœºæ—¶èƒ½è¯´è¯ã€‚

**å®ç°è¦ç‚¹**:
1. å®ç° `AudioManager` ç±»ï¼ˆCache-First ç­–ç•¥ï¼‰
2. å¼‚æ­¥è°ƒç”¨ `edge-tts` APIï¼ˆWorker Threadï¼‰
3. ä½¿ç”¨ `QMediaPlayer` æˆ– `miniaudio` æ’­æ”¾æœ¬åœ°æ–‡ä»¶
4. å®ç°éŸ³é¢‘é˜Ÿåˆ—å’Œä¼˜å…ˆçº§ä¸­æ–­æœºåˆ¶

**éªŒæ”¶æ ‡å‡†**:
- [ ] è§’è‰²å‡ºåœºåèƒ½æ’­æ”¾å¯¹åº”æ—¶æ®µçš„è¯­éŸ³
- [ ] è¯­éŸ³æ’­æ”¾ä¸é˜»å¡ GUIï¼ˆè§’è‰²åŠ¨ç”»å’Œè¯­éŸ³åŒæ­¥è¿›è¡Œï¼‰
- [ ] åŒä¸€å°è¯çš„éŸ³é¢‘è‡ªåŠ¨ç¼“å­˜ï¼ŒäºŒæ¬¡è§¦å‘æ— ç½‘ç»œè¯·æ±‚
- [ ] é€ƒè·‘æ—¶è¯­éŸ³ç«‹å³åœæ­¢
- [ ] æ— ç½‘ç»œæ—¶ä¸å´©æºƒï¼Œé™é»˜è·³è¿‡è¯­éŸ³åŠŸèƒ½

---

## 1.8 é¡¹ç›®åˆå§‹åŒ–å‘½ä»¤ (Project Bootstrap)

```powershell
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
mkdir CyberCompanion-Project
cd CyberCompanion-Project
mkdir src\core, src\ui, src\ai, assets\sprites, assets\sounds, assets\models, characters, tests, tools

# 2. åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ
python -m venv .venv
.\.venv\Scripts\Activate.ps1

# 3. å®‰è£…ä¾èµ–
pip install PySide6>=6.6.0 Pillow>=10.0.0 numpy>=1.24.0 edge-tts>=6.1.0 pywin32>=306

# 4. å†»ç»“ä¾èµ–
pip freeze > requirements.txt

# 5. åˆ›å»ºå…¥å£æ–‡ä»¶
New-Item src\main.py -ItemType File
New-Item src\core\__init__.py -ItemType File
New-Item src\ui\__init__.py -ItemType File
New-Item src\core\idle_monitor.py -ItemType File
New-Item src\core\director.py -ItemType File
New-Item src\core\asset_manager.py -ItemType File
New-Item src\core\audio_manager.py -ItemType File
New-Item src\ui\entity_window.py -ItemType File
New-Item src\ui\ascii_renderer.py -ItemType File
```

---

## 1.9 Phase 2 & 3 é¢„å‘Š

ä¸‹ä¸€é˜¶æ®µå°†æ·±å…¥å®ç°ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼ˆè¯¦è§ Phase 2-3 æ–‡æ¡£ï¼‰ï¼š
- **è§†è§‰æš‚ç•™ç³»ç»Ÿ (Ghosting)**: åˆ©ç”¨ `QGraphicsEffect` å®ç°èµ›åšæœ‹å…‹æ®‹å½±æ•ˆæœ
- **è§†è§‰æ„ŸçŸ¥ (OpenCV/MediaPipe)**: æ‘„åƒå¤´äººè„¸æ£€æµ‹ï¼Œè§’è‰²çš„çœ¼ç¥è·Ÿéšä½ çš„ä½ç½®ç§»åŠ¨
- **å¤§è¯­è¨€æ¨¡å‹ (LLM)**: OCR è¯†åˆ«å±å¹•æ–‡å­— + LLM ç”Ÿæˆåæ§½è¯„è®º
