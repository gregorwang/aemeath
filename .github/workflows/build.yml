name: Build and Release

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: windows-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 50

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements-build.txt

      - name: Recreate build_env
        shell: powershell
        run: |
          if (Test-Path build_env) {
            Remove-Item -Recurse -Force build_env
          }
          python -m venv build_env
          .\build_env\Scripts\python -m pip install --upgrade pip

      - name: Install build dependencies
        shell: powershell
        run: |
          .\build_env\Scripts\python -m pip install -r requirements-build.txt
          .\build_env\Scripts\python -m pip install "pyinstaller>=6.0.0"

      - name: Verify critical runtime modules
        shell: powershell
        run: |
          .\build_env\Scripts\python -c "import importlib.util as u; print('pycaw', bool(u.find_spec('pycaw'))); print('comtypes', bool(u.find_spec('comtypes'))); print('PySide6', bool(u.find_spec('PySide6')))"

      - name: Run tests
        shell: powershell
        run: |
          .\build_env\Scripts\python -m pytest tests/ -v --tb=short

      - name: Build EXE via build.spec
        shell: powershell
        run: |
          .\build_env\Scripts\python -m PyInstaller --clean --noconfirm build.spec

      - name: Smoke check executable and logs
        shell: powershell
        run: |
          $exePath = "dist\CyberCompanion\CyberCompanion-core.exe"
          if (-not (Test-Path $exePath)) {
            throw "Executable not found: $exePath"
          }

          $logDir = Join-Path $env:LOCALAPPDATA "CyberCompanion\logs"
          $logFile = Join-Path $logDir "app.log"
          if (Test-Path $logFile) {
            Remove-Item $logFile -Force
          }

          $proc = Start-Process -FilePath $exePath -PassThru
          Start-Sleep -Seconds 15
          if (-not $proc.HasExited) {
            Stop-Process -Id $proc.Id -Force
            Start-Sleep -Seconds 1
          }

          if (-not (Test-Path $logFile)) {
            throw "Smoke-check failed: app.log not found at $logFile"
          }

          $logText = Get-Content -Path $logFile -Raw
          if ($logText -notmatch "Application starting") {
            throw "Smoke-check failed: startup marker not found in app.log"
          }
          if ($logText -match "(ModuleNotFoundError|ImportError|Traceback \(most recent call last\)|Fatal Python error|CRITICAL)") {
            throw "Smoke-check failed: fatal import/runtime error detected in app.log"
          }
          if ($logText -notmatch "\[(AudioDetector|AudioOutputMonitor)\]") {
            throw "Smoke-check failed: expected audio monitor log entries not found"
          }

      - name: Create archive
        shell: powershell
        run: |
          $safeRef = "${{ github.ref_name }}" -replace "[\\/:\*\?""<>\|]", "-"
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $artifactName = "CyberCompanion_${safeRef}_${shortSha}"
          Compress-Archive -Path "dist\CyberCompanion\*" -DestinationPath "$artifactName.zip" -Force
          "ARTIFACT_NAME=$artifactName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip
          if-no-files-found: error
          retention-days: 14

      - name: Create GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARTIFACT_NAME }}.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
